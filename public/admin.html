<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - I-Card System</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
  margin: 0;
  padding: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  height: 100%;
  position: relative;
  overflow-x: hidden;
  background-color: #e6f0ff; /* fallback color */
}

body::before {
  content: "";
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: url("images/ecorHQ.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  filter: blur(7px);
  z-index: -1;
}


    .admin-container {
      display: flex;
      min-height: calc(100vh - 120px);
      flex-direction: column;
      align-items: center;
    }

    .img2{
      display: flex;
      padding-left: 990px;
      height: 50px;
      
    }

    .sidebar {
      width: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      order: 2;
    }

    .sidebar ul {
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 0 10px;
    }

    .sidebar li {
      margin-bottom: 0;
      flex: 1 0 auto;
    }

    .sidebar a {
      display: block;
      padding: 8px 12px;
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
      white-space: nowrap;
    }

    .sidebar a:hover, .sidebar a.active {
      background-color: rgba(255,255,255,0.1);
      transform: translateY(-2px);
    }

 .admin-content {
  flex: 1;
  padding: 30px;
  margin: 20px auto;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.15);
  width: 100%;
  max-width: 1200px; /* âœ… constrain layout */
  box-sizing: border-box;
}


.admin-content:hover {
  transform: translateY(-4px);
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
}
#login-section {
  background-color: #ffffff;
  border-radius: 12px;
  box-shadow: 0 16px 40px rgba(0, 0, 0, 0.2);
  width: 100%;
  max-width: 420px;
  padding: 40px 30px;
  box-sizing: border-box;
}


#login-section h3 {
  text-align: center;
  color: #003366;
  margin-bottom: 25px;
  font-weight: 600;
}


#login-section input[type="text"],
#login-section input[type="password"] {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-bottom: 15px;
}


#login-section input[type="submit"] {
  width: 100%;
  background: linear-gradient(135deg, #0073e6, #0051a8);
  color: white;
  padding: 12px;
  font-size: 16px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.3s ease;
}

#login-section input[type="submit"]:hover {
  background: linear-gradient(135deg, #005bb5, #003c80);
}




    

    .dataTables_wrapper {
      margin-top: 15px;
    }

    table.dataTable {
      border-collapse: collapse;
      width: 100%;
      font-size: 12px;
    }

    table.dataTable th,
    table.dataTable td {
      padding: 4px 6px;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    table.dataTable th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #333;
      border-right: 1px solid #e0e0e0;
      position: sticky;
      top: 0;
    }

    table.dataTable td {
      border-right: 1px solid #f0f0f0;
      vertical-align: middle;
    }

    table img {
      max-height: 30px;
      max-width: 50px;
      border-radius: 3px;
      object-fit: contain;
    }

    .dt-buttons .btn {
      margin-right: 5px;
      background: #667eea;
      border: none;
      color: white;
      padding: 3px 6px;
      border-radius: 3px;
      font-size: 11px;
    }

    .status-badge {
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
      background-color: #ffc107;
      color: #333;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }

    .status-badge.approved {
      background-color: #28a745;
      color: white;
    }

    .status-badge.rejected {
      background-color: #dc3545;
      color: white;
    }

    .status-badge.printing {
      background-color: #17a2b8;
      color: white;
    }

    .status-badge.pending {
      background-color: #ffc107;
      color: #333;
    }

    .status-badge.closed {
      background-color: #6c757d;
      color: white;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }

    .action-buttons button {
      padding: 3px 6px !important;
      font-size: 11px !important;
      margin: 1px !important;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      white-space: nowrap;
      display: inline-block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }

    .view-btn { background-color: #3498db; color: white; }
    .approve-btn { background-color: #2ecc71; color: white; }
    .reject-btn { background-color: #e74c3c; color: white; }
    .print-btn { background-color: #9b59b6; color: white; }
    .printing-btn { background-color: #17a2b8; color: white; }
    .download-btn { background-color: #6c757d; color: white; }
    .pending-btn { background-color: #f39c12; color: white; }

    .header {
      background: rgba(0, 43, 91, 0.9);
      color: white;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .header .logo img {
      height: 40px;
    }

    .header .title h1 {
      margin: 0;
      font-size: 18px;
    }

    .header .title h2 {
      margin: 3px 0 0 0;
      font-size: 14px;
      opacity: 0.9;
    }

    .footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 8px;
      margin-top: auto;
      font-size: 12px;
    }

    .table-container {
      overflow-x: auto;
      max-width: 100%;
      margin-top: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }

    /* Modal styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 15px;
    }

    .modal-content {
      background: white;
      padding: 15px;
      border-radius: 8px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .modal-close {
      background: #dc3545;
      color: white;
      border: none;
      padding: 3px 8px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    /* Main table styles */
    .main-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 14px;
    }

    .main-table td {
      padding: 8px;
      border: 1px solid #ddd;
    }

    .main-table .label {
      font-weight: bold;
      background-color: #f5f5f5;
      width: 15%;
      white-space: nowrap;
    }

    .main-table .value {
      width: 20%;
    }

    /* Divider */
    .divider {
      border-top: 1px solid #ddd;
      margin: 15px 0;
    }

    /* QR Code section */
    .qr-section {
      text-align: center;
      margin: 15px 0;
    }

    .qr-section h4 {
      margin-bottom: 10px;
    }

    .qr-code-container {
      display: inline-block;
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #ddd;
      background: white;
    }

    .qr-code-container img {
      width: 150px;
      height: 150px;
    }

    /* Family table */
    .family-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .family-table th, 
    .family-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    .family-table th {
      background-color: #f2f2f2;
      font-weight: bold;
    }

    /* Image section */
    .image-section {
      display: flex;
      gap: 20px;
      margin-top: 20px;
    }

    .image-container {
      flex: 1;
      text-align: center;
    }

    .image-container h4 {
      margin-bottom: 10px;
    }

    .image-container img {
      max-width: 100%;
      max-height: 150px;
      border: 1px solid #ddd;
      padding: 5px;
      background: white;
    }

    /* Modal actions */
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 1rem;
      height: 1rem;
      border: 2px solid rgba(0,0,0,0.1);
      border-radius: 50%;
      border-top-color: #007bff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Filter section styles */
    .filter-section {
      background-color: #f8f9fa;
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 15px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 8px;
    }

    .filter-group {
      flex: 1;
      min-width: 180px;
    }

    .filter-label {
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      font-size: 13px;
    }

    .filter-control {
      width: 100%;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #ced4da;
      font-size: 13px;
    }

    .filter-actions {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .filter-btn {
      padding: 5px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-size: 13px;
    }

    .filter-btn.apply {
      background-color: #28a745;
      color: white;
    }

    .filter-btn.reset {
      background-color: #dc3545;
      color: white;
    }

    .qr-code {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }

    /* Detail grid styles */
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .detail-row {
      display: contents;
    }

    .detail-label {
      font-weight: bold;
      padding: 8px;
      background-color: #f5f5f5;
    }

    .detail-value {
      padding: 8px;
      border-bottom: 1px solid #eee;
    }

    .section-divider {
      border-top: 1px solid #ddd;
      margin: 20px 0;
    }

    .section-title {
      margin-bottom: 10px;
      color: #333;
    }

    /* Responsive adjustments */
    @media (min-width: 768px) {
      .admin-container {
        flex-direction: row;
      }
     
      .sidebar {
        width: 220px;
        padding: 20px 0;
        order: 0;
      }

      .sidebar ul {
        display: block;
        padding: 0;
      }

      .sidebar li {
        margin-bottom: 5px;
      }

      .sidebar a {
        padding: 10px 15px;
        text-align: left;
        border-radius: 0;
        border-left: 3px solid transparent;
      }

      .sidebar a:hover, .sidebar a.active {
        transform: translateX(5px);
        border-left-color: #fff;
      }

      .admin-content {
        padding: 20px;
        margin: 15px;
      }

      .header {
        padding: 15px;
        gap: 15px;
      }

      .header .logo img {
        height: 50px;
      }

      .header .title h1 {
        font-size: 20px;
      }

      .header .title h2 {
        font-size: 16px;
      }
    }

    @media (max-width: 576px) {
      table.dataTable th,
      table.dataTable td {
        padding: 3px 4px;
        font-size: 11px;
      }

      .action-buttons {
        flex-direction: column;
        gap: 3px;
      }

      .action-buttons button {
        width: 100%;
      }

      .status-badge {
        min-width: 60px;
        font-size: 10px;
        padding: 2px 5px;
      }

      .main-table {
        font-size: 12px;
      }

      .main-table .label,
      .main-table .value {
        width: auto;
      }

      .image-section {
        flex-direction: column;
      }


    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      <img src="images/ecor.png" alt="East Coast Railway Logo">
    </div>
    <div class="title">
      <h1>Online Form for I-Cards</h1>
      <h2>East Coast Railway - Admin Panel</h2>
    </div>
    <div class="img2">
    <img  src="images/azadi-ka-amrit-mahotsav.png" alt="Amrit Mahotsav" />
    </div>
    
  </div>

  <div class="admin-container">
    <!-- Admin Login Section -->
    <div id="login-section" class="admin-content" style="max-width: 400px; margin: 30px auto;">
      <h3>Admin Login</h3>
      <form id="adminLoginForm">
        <div class="mb-3">
          <label for="username" class="form-label">Username:</label>
          <input type="text" class="form-control" id="username" name="username" required>
        </div>
        <div class="mb-3">
          <label for="password" class="form-label">Password:</label>
          <input type="password" class="form-control" id="password" name="password" required>
        </div>
        <button type="submit" class="btn btn-primary w-100">Login</button>
        <div id="login-message" class="mt-2"></div>
      </form>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" style="display: none;">
      <div class="sidebar">
        <ul>
          <li><a href="#" class="active" onclick="showSection('home')">Dashboard</a></li>
          <li><a href="#" onclick="showSection('gazetted-table')">Gazetted</a></li>
          <li><a href="#" onclick="showSection('non-gazetted-table')">Non-Gazetted</a></li>
          <li><a href="#" onclick="showSection('approved-apps')">Approved</a></li>
          <li><a href="#" onclick="showSection('rejected-apps')">Rejected</a></li>
          <li><a href="#" onclick="showSection('print-app')">Print</a></li>
          <li><a href="#" onclick="showSection('reports')">Reports</a></li>
          <li><a href="#" onclick="showSection('settings')">Settings</a></li>
          <li><a href="#" onclick="logout()">Logout</a></li>
        </ul>
      </div>

      <div class="admin-content">
        <!-- Dashboard Section -->
        <div id="home" class="content-section">
          <h3>Admin Dashboard</h3>
          <div class="filter-section">
            <div class="filter-row">
              <div class="filter-group">
                <label class="filter-label">Date Range:</label>
                <input type="text" id="date-range" class="filter-control" placeholder="Select date range">
              </div>
              <div class="filter-group">
                <label class="filter-label">Status:</label>
                <select id="status-filter" class="filter-control" multiple>
                  <option value="pending">Pending</option>
                  <option value="approved">Approved</option>
                  <option value="rejected">Rejected</option>
                  <option value="printing">Printing</option>
                  <option value="closed">Closed</option>
                </select>
              </div>
              <div class="filter-group">
                <label class="filter-label">Type:</label>
                <select id="type-filter" class="filter-control">
                  <option value="all">All</option>
                  <option value="gazetted">Gazetted</option>
                  <option value="non-gazetted">Non-Gazetted</option>
                </select>
              </div>
            </div>
            <div class="filter-actions">
              <button class="filter-btn apply" onclick="applyFilters()">Apply Filters</button>
              <button class="filter-btn reset" onclick="resetFilters()">Reset</button>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-3 col-6">
              <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                  <h5 class="card-title">Total Gazetted</h5>
                  <p class="card-text fs-4" id="total-gaz-count">0</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="card text-white bg-success mb-3">
                <div class="card-body">
                  <h5 class="card-title">Total Non-Gazetted</h5>
                  <p class="card-text fs-4" id="total-non-gaz-count">0</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                  <h5 class="card-title">Pending</h5>
                  <p class="card-text fs-4" id="pending-count">0</p>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6">
              <div class="card text-white bg-info mb-3">
                <div class="card-body">
                  <h5 class="card-title">Approved Today</h5>
                  <p class="card-text fs-4" id="approved-today-count">0</p>
                </div>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table id="dashboard-data-table" class="display nowrap" style="width:100%">
              <thead>
                <tr>
                  <th>Sl no</th>
                  <th>App No</th>
                  <th>Emp no</th>
                  <th>Emp name</th>
                  <th>Designation</th>
                  <th>DOB</th>
                  <th>Department</th>
                  <th>Station</th>
                  <th>Bill unit</th>
                  <th>Address</th>
                  <th>Rly no</th>
                  <th>Mobile no</th>
                  <th>Emergency contact</th>
                  <th>Application date</th>
                  <th>QR code</th>
                  <th>Photo</th>
                  <th>Signature</th>
                  <th>Family member</th>
                  <th>Blood group</th>
                  <th>Relation</th>
                  <th>Family DOB</th>
                  <th>Identity</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Gazetted Applications Table -->
        <div id="gazetted-table" class="content-section" style="display:none">
          <h3>Gazetted Applications</h3>
          <div class="table-container">
            <table id="gazetted-data-table" class="display nowrap" style="width:100%">
              <thead>
                <tr>
                  <th>Sl no</th>
                  <th>App No</th>
                  <th>Emp no</th>
                  <th>Emp name</th>
                  <th>Designation</th>
                  <th>DOB</th>
                  <th>Department</th>
                  <th>Station</th>
                  <th>Bill unit</th>
                  <th>Address</th>
                  <th>Rly no</th>
                  <th>Mobile no</th>
                  <th>Emergency contact</th>
                  <th>Application date</th>
                  <th>QR code</th>
                  <th>Photo</th>
                  <th>Signature</th>
                  <th>Family member</th>
                  <th>Blood group</th>
                  <th>Relation</th>
                  <th>Family DOB</th>
                  <th>Identity</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Non-Gazetted Applications Table -->
        <div id="non-gazetted-table" class="content-section" style="display:none">
          <h3>Non-Gazetted Applications</h3>
          <div class="table-container">
            <table id="non-gazetted-data-table" class="display nowrap" style="width:100%">
              <thead>
                <tr>
                  <th>Sl no</th>
                  <th>App No</th>
                  <th>Emp no</th>
                  <th>Emp name</th>
                  <th>Designation</th>
                  <th>DOB</th>
                  <th>Department</th>
                  <th>Station</th>
                  <th>Bill unit</th>
                  <th>Address</th>
                  <th>Rly no</th>
                  <th>Mobile no</th>
                  <th>Emergency contact</th>
                  <th>Application date</th>
                  <th>QR code</th>
                  <th>Photo</th>
                  <th>Signature</th>
                  <th>Family member</th>
                  <th>Blood group</th>
                  <th>Relation</th>
                  <th>Family DOB</th>
                  <th>Identity</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Approved Applications Table -->
        <div id="approved-apps" class="content-section" style="display:none">
          <h3>Approved Applications</h3>
          <div class="table-container">
            <table id="approved-data-table" class="display nowrap" style="width:100%">
              <thead>
                <tr>
                  <th>Sl no</th>
                  <th>App No</th>
                  <th>Type</th>
                  <th>Emp no</th>
                  <th>Emp name</th>
                  <th>Designation</th>
                  <th>DOB</th>
                  <th>Department</th>
                  <th>Station</th>
                  <th>Bill unit</th>
                  <th>Address</th>
                  <th>Rly no</th>
                  <th>Mobile no</th>
                  <th>Emergency contact</th>
                  <th>Application date</th>
                  <th>QR code</th>
                  <th>Photo</th>
                  <th>Signature</th>
                  <th>Family member</th>
                  <th>Blood group</th>
                  <th>Relation</th>
                  <th>Family DOB</th>
                  <th>Identity</th>
                  <th>Approved Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Rejected Applications Table -->
        <div id="rejected-apps" class="content-section" style="display:none">
          <h3>Rejected Applications</h3>
          <div class="table-container">
            <table id="rejected-data-table" class="display nowrap" style="width:100%">
              <thead>
                <tr>
                  <th>Sl no</th>
                  <th>App No</th>
                  <th>Type</th>
                  <th>Emp no</th>
                  <th>Emp name</th>
                  <th>Designation</th>
                  <th>DOB</th>
                  <th>Department</th>
                  <th>Station</th>
                  <th>Bill unit</th>
                  <th>Address</th>
                  <th>Rly no</th>
                  <th>Mobile no</th>
                  <th>Emergency contact</th>
                  <th>Application date</th>
                  <th>QR code</th>
                  <th>Photo</th>
                  <th>Signature</th>
                  <th>Family member</th>
                  <th>Blood group</th>
                  <th>Relation</th>
                  <th>Family DOB</th>
                  <th>Identity</th>
                  <th>Rejected Date</th>
                  <th>Reason</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Print Applications Section -->
        <div id="print-app" class="content-section" style="display: none;">
          <h3>Print Applications</h3>
          <div class="row mt-3">
            <div class="col-md-6">
              <div class="input-group mb-3">
                <input type="text" id="print-search-id" class="form-control" placeholder="Enter application number">
                <button class="btn btn-primary" onclick="searchPrintApplication()">Search</button>
              </div>
            </div>
          </div>
          <div id="print-application-result" style="display: none;">
            <div class="card mt-3">
              <div class="card-body">
                <h5 class="card-title" id="print-app-name"></h5>
                <div class="row">
                  <div class="col-md-6">
                    <p class="mb-1"><strong>Application No:</strong> <span id="print-app-no"></span></p>
                    <p class="mb-1"><strong>Employee No:</strong> <span id="print-app-empno"></span></p>
                    <p class="mb-1"><strong>Designation:</strong> <span id="print-app-designation"></span></p>
                  </div>
                  <div class="col-md-6">
                    <p class="mb-1"><strong>Department:</strong> <span id="print-app-department"></span></p>
                    <p class="mb-1"><strong>Application Date:</strong> <span id="print-app-date"></span></p>
                    <p class="mb-1"><strong>Status:</strong> <span id="print-app-status"></span></p>
                  </div>
                </div>
                <div class="mt-3">
                  <button class="btn btn-success btn-sm" onclick="printApplicationById(document.getElementById('print-search-id').value)">
                    <i class="bi bi-printer"></i> Print
                  </button>
                  <button class="btn btn-primary btn-sm ms-2" onclick="downloadApplication(document.getElementById('print-search-id').value)">
                    <i class="bi bi-download"></i> Download
                  </button>
                  <button class="btn btn-info btn-sm ms-2" onclick="viewApplication(document.getElementById('print-app-id').value, document.getElementById('print-app-type').value)">
                    <i class="bi bi-eye"></i> View Details
                  </button>
                </div>
              </div>
            </div>
          </div>
          <input type="hidden" id="print-app-type">
          <input type="hidden" id="print-app-id">
        </div>

        <!-- Reports Section -->
        <div id="reports" class="content-section" style="display: none;">
          <h3>Generate Reports</h3>
          <div class="row mt-3">
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Date Range Report</h5>
                  <div class="mb-3">
                    <label for="report-start-date" class="form-label">Start Date:</label>
                    <input type="date" id="report-start-date" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label for="report-end-date" class="form-label">End Date:</label>
                    <input type="date" id="report-end-date" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label for="report-type" class="form-label">Report Type:</label>
                    <select id="report-type" class="form-control">
                      <option value="all">All Applications</option>
                      <option value="gazetted">Gazetted Only</option>
                      <option value="non-gazetted">Non-Gazetted Only</option>
                      <option value="approved">Approved Only</option>
                      <option value="rejected">Rejected Only</option>
                    </select>
                  </div>
                  <button class="btn btn-primary" onclick="generateReport()">Generate Report</button>
                  <div id="report-message" class="mt-2"></div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Quick Reports</h5>
                  <button class="btn btn-secondary w-100 mb-2" onclick="generateQuickReport('today')">Today's Applications</button>
                  <button class="btn btn-secondary w-100 mb-2" onclick="generateQuickReport('week')">This Week's Applications</button>
                  <button class="btn btn-secondary w-100 mb-2" onclick="generateQuickReport('month')">This Month's Applications</button>
                  <button class="btn btn-secondary w-100 mb-2" onclick="generateQuickReport('pending')">All Pending Applications</button>
                  <button class="btn btn-secondary w-100" onclick="generateQuickReport('printed')">All Printed Applications</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section" style="display: none;">
          <h3>System Settings</h3>
          <div class="card mt-3">
            <div class="card-body">
              <h5 class="card-title">Admin Password Change</h5>
              <form id="change-password-form">
                <div class="mb-3">
                  <label for="current-password" class="form-label">Current Password:</label>
                  <input type="password" class="form-control" id="current-password" required>
                </div>
                <div class="mb-3">
                  <label for="new-password" class="form-label">New Password:</label>
                  <input type="password" class="form-control" id="new-password" required>
                </div>
                <div class="mb-3">
                  <label for="confirm-password" class="form-label">Confirm New Password:</label>
                  <input type="password" class="form-control" id="confirm-password" required>
                </div>
                <button type="submit" class="btn btn-primary">Change Password</button>
                <div id="password-change-message" class="mt-2"></div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <p>Designed, Developed and Maintained by Interns</p>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.68/vfs_fonts.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>


  <script>
 // Complete JavaScript code for admin.html
document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('adminToken');
  if (token) {
    showAdminPanel();
    initializeDataTables();
    initializeDateRangePicker();
  }
});

let gazettedTable, nonGazettedTable, approvedTable, rejectedTable, dashboardTable;
let currentFilters = {};

function initializeDateRangePicker() {
  flatpickr("#date-range", {
    mode: "range",
    dateFormat: "Y-m-d",
    allowInput: true
  });
}

function generateQRCode(data) {
  const qr = qrcode(0, 'L');
  const qrData = JSON.stringify({
    empName: data.name || 'N/A',
    designation: data.designation || 'N/A',
    empNo: data.ruid || data.empNo || 'N/A',
    department: data.department || 'N/A'
  });
  qr.addData(qrData);
  qr.make();
  const qrImg = qr.createImgTag(4);
  const src = qrImg.match(/src="([^"]*)"/)[1];
  return `<img src="${src}" class="qr-code" alt="QR Code">`;
}

function initializeDataTables() {
  const token = localStorage.getItem('adminToken');
  if (!token) {
    console.error('No admin token found');
    return;
  }

  const commonAjaxConfig = {
    headers: {
      'Authorization': `Bearer ${token}`
    },
    error: function(xhr, error, thrown) {
      console.error('DataTables AJAX error:', xhr, error, thrown);
      if (xhr.status === 401) {
        alert('Session expired. Please login again.');
        logout();
      } else {
        alert('Error loading data. Please check console for details.');
      }
    }
  };

  // Dashboard Table
  dashboardTable = $('#dashboard-data-table').DataTable({
    ajax: {
      url: '/api/admin/applications',
      ...commonAjaxConfig,
      data: function(d) {
        d.filters = currentFilters;
        d.sortBy = 'updatedAt';
        d.sortOrder = 'desc';
      },
      dataSrc: function(json) {
        if (!json || !json.success) {
          console.error('Invalid response format', json);
          return [];
        }
        return (json.data || []).map(item => {
          if (!item.applicationNo) item.applicationNo = 'N/A';
          if (!item.ruid && !item.empNo) item.ruid = 'N/A';
          if (!item.family) item.family = [{}];
          return item;
        });
      }
    },
    columns: [
      { 
        data: null, 
        render: (data, type, row, meta) => meta.row + 1 
      },
      { 
        data: 'applicationNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'ruid',
        render: data => data || 'N/A'
      },
      { 
        data: 'name',
        defaultContent: 'N/A'
      },
      { 
        data: 'designation',
        defaultContent: 'N/A'
      },
      { 
        data: 'dob', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: 'department',
        defaultContent: 'N/A'
      },
      { 
        data: 'station',
        defaultContent: 'N/A'
      },
      { 
        data: 'billUnit',
        defaultContent: 'N/A'
      },
      { 
        data: 'address',
        defaultContent: 'N/A'
      },
      { 
        data: 'rlyNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'mobile',
        defaultContent: 'N/A'
      },
      { 
        data: null,
        render: data => {
          return data.emergencyContactName ? 
            `${data.emergencyContactName} (${data.emergencyContactNumber || 'N/A'})` : 
            'N/A';
        }
      },
      { 
        data: 'createdAt', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: null,
        render: function(data) {
          return generateQRCode(data);
        }
      },
      { 
        data: 'photo', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="30" height="30">` : 
          'N/A'
      },
      { 
        data: 'sign', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="50" height="30">` : 
          'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].name || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].bloodGroup || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].relationship || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? 
          (data[0].dob ? new Date(data[0].dob).toLocaleDateString() : 'N/A') : 
          'N/A'
      },
      { 
        data: '_id',
        defaultContent: 'N/A'
      },
      { 
        data: 'status',
        render: data => {
          let badgeClass = data || 'pending';
          if (data === 'approved') badgeClass = 'approved';
          else if (data === 'rejected') badgeClass = 'rejected';
          else if (data === 'printing') badgeClass = 'printing';
          else if (data === 'closed') badgeClass = 'closed';
          return `<span class="status-badge ${badgeClass}">${data || 'N/A'}</span>`;
        }
      },
      {
        data: null,
        render: function(data) {
          let buttons = `
            <div class="action-buttons">
              <button class="view-btn" onclick="viewApplication('${data._id}', '${data.type || 'gazetted'}')">View</button>
          `;
          
          const status = (data.status || '').toLowerCase();
          
          if (status === 'pending') {
            buttons += `
              <button class="approve-btn" onclick="approveApplication('${data._id}', '${data.type || 'gazetted'}')">Approve</button>
              <button class="reject-btn" onclick="showRejectDialog('${data._id}', '${data.type || 'gazetted'}')">Reject</button>
            `;
          } else if (status === 'approved') {
            buttons += `
              <button class="download-btn" onclick="downloadIdCard('${data._id}')">Download ID</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', '${data.type || 'gazetted'}')">Set Pending</button>
            `;
          } else if (status === 'rejected') {
            buttons += `
              <button class="approve-btn" onclick="approveApplication('${data._id}', '${data.type || 'gazetted'}')">Approve</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', '${data.type || 'gazetted'}')">Set Pending</button>
            `;
          }
          
          buttons += `</div>`;
          return buttons;
        }
      }
    ],
    dom: 'Bfrtip',
    buttons: ['copy', 'excel', 'pdf', 'print'],
    scrollX: true,
    scrollY: '500px',
    scrollCollapse: true,
    paging: true,
    responsive: true,
    order: [[13, 'desc']]
  });

  // Gazetted Table
  gazettedTable = $('#gazetted-data-table').DataTable({
    ajax: {
      url: '/api/admin/gazetted',
      ...commonAjaxConfig,
      dataSrc: function(json) {
        if (!json || !json.success) {
          console.error('Invalid response format', json);
          return [];
        }
        return (json.data || []).map(item => {
          if (!item.applicationNo) item.applicationNo = 'N/A';
          if (!item.family) item.family = [{}];
          return item;
        });
      }
    },
    columns: [
      { 
        data: null, 
        render: (data, type, row, meta) => meta.row + 1 
      },
      { 
        data: 'applicationNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'ruid',
        defaultContent: 'N/A'
      },
      { 
        data: 'name',
        defaultContent: 'N/A'
      },
      { 
        data: 'designation',
        defaultContent: 'N/A'
      },
      { 
        data: 'dob', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: 'department',
        defaultContent: 'N/A'
      },
      { 
        data: 'station',
        defaultContent: 'N/A'
      },
      { 
        data: 'billUnit',
        defaultContent: 'N/A'
      },
      { 
        data: 'address',
        defaultContent: 'N/A'
      },
      { 
        data: 'rlyNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'mobile',
        defaultContent: 'N/A'
      },
      { 
        data: null,
        render: data => {
          return data.emergencyContactName ? 
            `${data.emergencyContactName} (${data.emergencyContactNumber || 'N/A'})` : 
            'N/A';
        }
      },
      { 
        data: 'createdAt', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: null,
        render: function(data) {
          return generateQRCode(data);
        }
      },
      { 
        data: 'photo', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="30" height="30">` : 
          'N/A'
      },
      { 
        data: 'sign', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="50" height="30">` : 
          'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].name || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].bloodGroup || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].relationship || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? 
          (data[0].dob ? new Date(data[0].dob).toLocaleDateString() : 'N/A') : 
          'N/A'
      },
      { 
        data: '_id',
        defaultContent: 'N/A'
      },
      { 
        data: 'status',
        render: data => {
          let badgeClass = data || 'pending';
          if (data === 'approved') badgeClass = 'approved';
          else if (data === 'rejected') badgeClass = 'rejected';
          else if (data === 'printing') badgeClass = 'printing';
          else if (data === 'closed') badgeClass = 'closed';
          return `<span class="status-badge ${badgeClass}">${data || 'N/A'}</span>`;
        }
      },
      {
        data: null,
        render: function(data) {
          let buttons = `
            <div class="action-buttons">
              <button class="view-btn" onclick="viewApplication('${data._id}', 'gazetted')">View</button>
          `;
          
          const status = (data.status || '').toLowerCase();
          
          if (status === 'pending') {
            buttons += `
              <button class="approve-btn" onclick="approveApplication('${data._id}', 'gazetted')">Approve</button>
              <button class="reject-btn" onclick="showRejectDialog('${data._id}', 'gazetted')">Reject</button>
            `;
          } else if (status === 'approved') {
            buttons += `
              <button class="download-btn" onclick="downloadIdCard('${data._id}')">Download ID</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', 'gazetted')">Set Pending</button>
            `;
          } else if (status === 'rejected') {
            buttons += `
              <button class="approve-btn" onclick="approveApplication('${data._id}', 'gazetted')">Approve</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', 'gazetted')">Set Pending</button>
            `;
          }
          
          buttons += `</div>`;
          return buttons;
        }
      }
    ],
    dom: 'Bfrtip',
    buttons: ['copy', 'excel', 'pdf', 'print'],
    scrollX: true,
    scrollY: '500px',
    scrollCollapse: true,
    paging: true,
    responsive: true,
    order: [[13, 'desc']]
  });

  // Non-Gazetted Table
  nonGazettedTable = $('#non-gazetted-data-table').DataTable({
    ajax: {
      url: '/api/admin/non-gazetted',
      ...commonAjaxConfig,
      dataSrc: function(json) {
        if (!json || !json.success) {
          console.error('Invalid response format', json);
          return [];
        }
        return (json.data || []).map(item => {
          if (!item.applicationNo) item.applicationNo = 'N/A';
          if (!item.family) item.family = [{}];
          return item;
        });
      }
    },
    columns: [
      { 
        data: null, 
        render: (data, type, row, meta) => meta.row + 1 
      },
      { 
        data: 'applicationNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'empNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'name',
        defaultContent: 'N/A'
      },
      { 
        data: 'designation',
        defaultContent: 'N/A'
      },
      { 
        data: 'dob', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: 'department',
        defaultContent: 'N/A'
      },
      { 
        data: 'station',
        defaultContent: 'N/A'
      },
      { 
        data: 'billUnit',
        defaultContent: 'N/A'
      },
      { 
        data: 'address',
        defaultContent: 'N/A'
      },
      { 
        data: 'rlyNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'mobile',
        defaultContent: 'N/A'
      },
      { 
        data: null,
        render: data => {
          return data.emergencyContactName ? 
            `${data.emergencyContactName} (${data.emergencyContactNumber || 'N/A'})` : 
            'N/A';
        }
      },
      { 
        data: 'createdAt', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: null,
        render: function(data) {
          return generateQRCode(data);
        }
      },
      { 
        data: 'photo', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="30" height="30">` : 
          'N/A'
      },
      { 
        data: 'sign', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="50" height="30">` : 
          'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].name || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].bloodGroup || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].relationship || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? 
          (data[0].dob ? new Date(data[0].dob).toLocaleDateString() : 'N/A') : 
          'N/A'
      },
      { 
        data: '_id',
        defaultContent: 'N/A'
      },
      { 
        data: 'status',
        render: data => {
          let badgeClass = data || 'pending';
          if (data === 'approved') badgeClass = 'approved';
          else if (data === 'rejected') badgeClass = 'rejected';
          else if (data === 'printing') badgeClass = 'printing';
          else if (data === 'closed') badgeClass = 'closed';
          return `<span class="status-badge ${badgeClass}">${data || 'N/A'}</span>`;
        }
      },
      {
        data: null,
        render: function(data) {
          let buttons = `
            <div class="action-buttons">
              <button class="view-btn" onclick="viewApplication('${data._id}', 'non-gazetted')">View</button>
          `;
          
          const status = (data.status || '').toLowerCase();
          
          if (status === 'pending') {
            buttons += `
              <button class="approve-btn" onclick="approveApplication('${data._id}', 'non-gazetted')">Approve</button>
              <button class="reject-btn" onclick="showRejectDialog('${data._id}', 'non-gazetted')">Reject</button>
            `;
          } else if (status === 'approved') {
            buttons += `
              <button class="download-btn" onclick="downloadIdCard('${data._id}')">Download ID</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', 'non-gazetted')">Set Pending</button>
            `;
          } else if (status === 'rejected') {
            buttons += `
              <button class="approve-btn" onclick="approveApplication('${data._id}', 'non-gazetted')">Approve</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', 'non-gazetted')">Set Pending</button>
            `;
          }
          
          buttons += `</div>`;
          return buttons;
        }
      }
    ],
    dom: 'Bfrtip',
    buttons: ['copy', 'excel', 'pdf', 'print'],
    scrollX: true,
    scrollY: '500px',
    scrollCollapse: true,
    paging: true,
    responsive: true,
    order: [[13, 'desc']]
  });

  // Approved Table
  approvedTable = $('#approved-data-table').DataTable({
    ajax: {
      url: '/api/admin/approved',
      ...commonAjaxConfig,
      dataSrc: function(json) {
        if (!json || !json.success) {
          console.error('Invalid response format', json);
          return [];
        }
        return (json.data || []).map(item => {
          if (!item.applicationNo) item.applicationNo = 'N/A';
          if (!item.family) item.family = [{}];
          return item;
        });
      }
    },
    columns: [
      { 
        data: null, 
        render: (data, type, row, meta) => meta.row + 1 
      },
      { 
        data: 'applicationNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'type',
        render: data => data === 'gazetted' ? 'Gazetted' : 'Non-Gazetted'
      },
      { 
        data: 'ruid',
        render: data => data || 'N/A'
      },
      { 
        data: 'name',
        defaultContent: 'N/A'
      },
      { 
        data: 'designation',
        defaultContent: 'N/A'
      },
      { 
        data: 'dob', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: 'department',
        defaultContent: 'N/A'
      },
      { 
        data: 'station',
        defaultContent: 'N/A'
      },
      { 
        data: 'billUnit',
        defaultContent: 'N/A'
      },
      { 
        data: 'address',
        defaultContent: 'N/A'
      },
      { 
        data: 'rlyNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'mobile',
        defaultContent: 'N/A'
      },
      { 
        data: null,
        render: data => {
          return data.emergencyContactName ? 
            `${data.emergencyContactName} (${data.emergencyContactNumber || 'N/A'})` : 
            'N/A';
        }
      },
      { 
        data: 'createdAt', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: null,
        render: function(data) {
          return generateQRCode(data);
        }
      },
      { 
        data: 'photo', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="30" height="30">` : 
          'N/A'
      },
      { 
        data: 'sign', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="50" height="30">` : 
          'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].name || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].bloodGroup || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].relationship || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? 
          (data[0].dob ? new Date(data[0].dob).toLocaleDateString() : 'N/A') : 
          'N/A'
      },
      { 
        data: '_id',
        defaultContent: 'N/A'
      },
      { 
        data: 'updatedAt', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      {
        data: null,
        render: function(data) {
          return `
            <div class="action-buttons">
              <button class="view-btn" onclick="viewApplication('${data._id}', '${data.type || 'gazetted'}')">View</button>
              <button class="download-btn" onclick="downloadIdCard('${data._id}')">Download ID</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', '${data.type || 'gazetted'}')">Set Pending</button>
            </div>
          `;
        }
      }
    ],
    dom: 'Bfrtip',
    buttons: ['copy', 'excel', 'pdf', 'print'],
    scrollX: true,
    scrollY: '500px',
    scrollCollapse: true,
    paging: true,
    responsive: true,
    order: [[23, 'desc']]
  });

  // Rejected Table
  rejectedTable = $('#rejected-data-table').DataTable({
    ajax: {
      url: '/api/admin/rejected',
      ...commonAjaxConfig,
      dataSrc: function(json) {
        if (!json || !json.success) {
          console.error('Invalid response format', json);
          return [];
        }
        return (json.data || []).map(item => {
          if (!item.applicationNo) item.applicationNo = 'N/A';
          if (!item.family) item.family = [{}];
          return item;
        });
      }
    },
    columns: [
      { 
        data: null, 
        render: (data, type, row, meta) => meta.row + 1 
      },
      { 
        data: 'applicationNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'type',
        render: data => data === 'gazetted' ? 'Gazetted' : 'Non-Gazetted'
      },
      { 
        data: 'ruid',
        render: data => data || 'N/A'
      },
      { 
        data: 'name',
        defaultContent: 'N/A'
      },
      { 
        data: 'designation',
        defaultContent: 'N/A'
      },
      { 
        data: 'dob', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: 'department',
        defaultContent: 'N/A'
      },
      { 
        data: 'station',
        defaultContent: 'N/A'
      },
      { 
        data: 'billUnit',
        defaultContent: 'N/A'
      },
      { 
        data: 'address',
        defaultContent: 'N/A'
      },
      { 
        data: 'rlyNo',
        defaultContent: 'N/A'
      },
      { 
        data: 'mobile',
        defaultContent: 'N/A'
      },
      { 
        data: null,
        render: data => {
          return data.emergencyContactName ? 
            `${data.emergencyContactName} (${data.emergencyContactNumber || 'N/A'})` : 
            'N/A';
        }
      },
      { 
        data: 'createdAt', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: null,
        render: function(data) {
          return generateQRCode(data);
        }
      },
      { 
        data: 'photo', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="30" height="30">` : 
          'N/A'
      },
      { 
        data: 'sign', 
        render: data => data ? 
          `<img src="/uploads/${data}" width="50" height="30">` : 
          'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].name || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].bloodGroup || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? data[0].relationship || 'N/A' : 'N/A'
      },
      { 
        data: 'family',
        render: data => data && data.length ? 
          (data[0].dob ? new Date(data[0].dob).toLocaleDateString() : 'N/A') : 
          'N/A'
      },
      { 
        data: '_id',
        defaultContent: 'N/A'
      },
      { 
        data: 'updatedAt', 
        render: data => data ? new Date(data).toLocaleDateString() : 'N/A'
      },
      { 
        data: 'rejectionReason',
        defaultContent: 'N/A'
      },
      {
        data: null,
        render: function(data) {
          return `
            <div class="action-buttons">
              <button class="view-btn" onclick="viewApplication('${data._id}', '${data.type || 'gazetted'}')">View</button>
              <button class="approve-btn" onclick="approveApplication('${data._id}', '${data.type || 'gazetted'}')">Approve</button>
              <button class="pending-btn" onclick="setStatusToPending('${data._id}', '${data.type || 'gazetted'}')">Set Pending</button>
            </div>
          `;
        }
      }
    ],
    dom: 'Bfrtip',
    buttons: ['copy', 'excel', 'pdf', 'print'],
    scrollX: true,
    scrollY: '500px',
    scrollCollapse: true,
    paging: true,
    responsive: true,
    order: [[24, 'desc']]
  });

  loadCounts();
}

async function downloadIdCard(id) {
  try {
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.innerHTML = `
      <div class="modal-content" style="text-align: center; padding: 20px;">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 15px;"></div>
        <p>Generating ID Card...</p>
      </div>
    `;
    document.body.appendChild(loadingModal);
    
    const response = await fetch(`/api/admin/generate-id-card/${id}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
      }
    });

    if (!response.ok) {
      throw new Error(await response.text());
    }

    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ECoR_ID_${id}.pdf`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    loadingModal.remove();
    
  } catch (error) {
    console.error('Download error:', error);
    alert('Failed to download ID card: ' + error.message);
  }
}

async function loadCounts() {
  try {
    const response = await fetch('/api/admin/counts', {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    
    if (!data.success) {
      throw new Error(data.error || 'Failed to load counts');
    }
    
    document.getElementById('total-gaz-count').textContent = data.data.totalGazetted || 0;
    document.getElementById('total-non-gaz-count').textContent = data.data.totalNonGazetted || 0;
    document.getElementById('pending-count').textContent = data.data.pending || 0;
    document.getElementById('approved-today-count').textContent = data.data.approvedToday || 0;
  } catch (error) {
    console.error('Error loading counts:', error);
    alert('Error loading dashboard counts. Please check console for details.');
  }
}

function applyFilters() {
  currentFilters = {};
  
  const dateRange = document.getElementById('date-range').value;
  if (dateRange) {
    const dates = dateRange.split(' to ');
    if (dates.length === 2) {
      currentFilters.startDate = dates[0];
      currentFilters.endDate = dates[1];
    }
  }
  
  const statusSelect = document.getElementById('status-filter');
  const selectedStatus = Array.from(statusSelect.selectedOptions).map(option => option.value);
  if (selectedStatus.length > 0) {
    currentFilters.status = selectedStatus;
  }
  
  const typeFilter = document.getElementById('type-filter').value;
  if (typeFilter !== 'all') {
    currentFilters.type = typeFilter;
  }
  
  if (dashboardTable) {
    dashboardTable.ajax.reload();
  }
}

function resetFilters() {
  document.getElementById('date-range').value = '';
  document.getElementById('status-filter').selectedIndex = -1;
  document.getElementById('type-filter').value = 'all';
  currentFilters = {};
  
  if (dashboardTable) {
    dashboardTable.ajax.reload();
  }
}

async function setStatusToPending(id, type) {
  if (!confirm('Are you sure you want to set this application back to pending status?')) return;
  
  try {
    const response = await fetch(`/api/admin/${type}/${id}/pending`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.success) {
      alert('Application status set to pending successfully!');
      if (gazettedTable) gazettedTable.ajax.reload();
      if (nonGazettedTable) nonGazettedTable.ajax.reload();
      if (approvedTable) approvedTable.ajax.reload();
      if (rejectedTable) rejectedTable.ajax.reload();
      if (dashboardTable) dashboardTable.ajax.reload();
      loadCounts();
    } else {
      throw new Error(result.error || 'Failed to update status');
    }
  } catch (error) {
    console.error('Error setting status to pending:', error);
    alert('Error: ' + error.message);
  }
}

async function viewApplication(appId, type) {
  try {
    const loadingModal = document.createElement('div');
    loadingModal.className = 'modal-overlay';
    loadingModal.innerHTML = `
      <div class="modal-content" style="text-align: center; padding: 20px;">
        <div class="loading-spinner" style="width: 40px; height: 40px; margin: 0 auto 15px;"></div>
        <p>Loading application details...</p>
      </div>
    `;
    document.body.appendChild(loadingModal);
    
    const response = await fetch(`/api/admin/applications/${appId}`, {
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`,
        'Content-Type': 'application/json'
      }
    });

    loadingModal.remove();

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.message || `Failed to fetch application (HTTP ${response.status})`);
    }

    const result = await response.json();
    
    if (!result.success) {
      throw new Error(result.error || 'Error loading application data');
    }

    displayApplicationModal(result.data, appId, type);
    
  } catch (error) {
    console.error('View Application Error:', error);
    
    const errorModal = document.createElement('div');
    errorModal.className = 'modal-overlay';
    errorModal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h3>Error</h3>
          <button class="close-modal" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
        </div>
        <div class="modal-body">
          <div class="error-message">
            Failed to load application details:<br><br>
            <strong>Error:</strong> ${error.message}<br><br>
            Please verify:<br>
            1. The application exists in the system<br>
            2. You have proper permissions<br>
            3. The backend service is running
          </div>
        </div>
        <div class="modal-actions">
          <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
        </div>
      </div>
    `;
    document.body.appendChild(errorModal);
  }
}

function displayApplicationModal(application, appId, type) {
  const formatDate = (dateString) => {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleDateString('en-IN', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
  };

  const qr = qrcode(0, 'L');
  qr.addData(JSON.stringify({
    id: application.applicationNo || 'N/A',
    name: application.name || 'N/A',
    empNo: type === 'gazetted' ? application.ruid : application.empNo || 'N/A'
  }));
  qr.make();
  const qrImg = qr.createImgTag(4);

  let familyTable = '';
  if (application.family && application.family.length > 0) {
    familyTable = `
      <table class="family-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Blood Group</th>
            <th>Relationship</th>
            <th>DOB</th>
            <th>Identification marks(s)</th>
          </tr>
        </thead>
        <tbody>
          ${application.family.map(member => `
            <tr>
              <td>${member.name || 'N/A'}</td>
              <td>${member.bloodGroup || 'N/A'}</td>
              <td>${member.relationship || 'N/A'}</td>
              <td>${member.dob ? formatDate(member.dob) : 'N/A'}</td>
              <td>${member.identificationMarks || 'N/A'}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  const modal = document.createElement('div');
  modal.className = 'modal-overlay application-modal';
  
  modal.innerHTML = `
    <div class="modal-content application-view">
      <div class="modal-header">
        <h3>ID No: ${application.applicationNo || 'N/A'}</h3>
        <button class="close-modal" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
      </div>
      <div class="modal-body">
        <table class="main-table">
          <tr>
            <td class="label">EMPNO</td>
            <td class="value">${type === 'gazetted' ? application.ruid : application.empNo || 'N/A'}</td>
            <td class="label">EMPNAME</td>
            <td class="value">${application.name || 'N/A'}</td>
            <td class="label">DESIGNATION</td>
            <td class="value">${application.designation || 'N/A'}</td>
          </tr>
          <tr>
            <td class="label">DOB</td>
            <td class="value">${application.dob ? formatDate(application.dob) : 'N/A'}</td>
            <td class="label">DEPARTMENT</td>
            <td class="value">${application.department || 'N/A'}</td>
            <td class="label">STATION</td>
            <td class="value">${application.station || 'N/A'}</td>
          </tr>
          <tr>
            <td class="label">ADDRESS</td>
            <td class="value" colspan="3">${application.address || 'N/A'}</td>
            <td class="label">RLY NUMBER</td>
            <td class="value">${application.rlyNo || 'N/A'}</td>
          </tr>
          <tr>
            <td class="label">MOBILE NUMBER</td>
            <td class="value">${application.mobile || 'N/A'}</td>
            <td class="label">EMERGENCY CONTACT NAME</td>
            <td class="value">${application.emergencyContactName || 'N/A'}</td>
            <td class="label">EMERGENCY CONTACT NO</td>
            <td class="value">${application.emergencyContactNumber || 'N/A'}</td>
          </tr>
          <tr>
            <td class="label">APPLICATION DATE</td>
            <td class="value">${application.createdAt ? formatDate(application.createdAt) : 'N/A'}</td>
            <td class="label">DEPT SL NO</td>
            <td class="value">${application.deptSlNo || 'N/A'}</td>
            <td colspan="2"></td>
          </tr>
        </table>

        <div class="divider"></div>

        <div class="qr-section">
          <h4>QR Code</h4>
          <div class="qr-code-container">
            ${qrImg}
          </div>
        </div>

        <div class="divider"></div>

        <h4>Family Members</h4>
        ${familyTable}

        <div class="image-section">
          <div class="image-container">
            <h4>Photo</h4>
            ${application.photo ? `<img src="/uploads/${application.photo}" alt="Applicant Photo">` : 'No photo available'}
          </div>
          <div class="image-container">
            <h4>Signature</h4>
            ${application.sign ? `<img src="/uploads/${application.sign}" alt="Applicant Signature">` : 'No signature available'}
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="download-btn" onclick="downloadIdCard('${appId}')">Download ID Card</button>
        ${application.status === 'pending' ? `
          <button class="approve-btn" onclick="approveApplication('${appId}', '${type}')">Approve</button>
          <button class="reject-btn" onclick="showRejectDialog('${appId}', '${type}')">Reject</button>
        ` : ''}
        <button class="close-btn" onclick="this.closest('.modal-overlay').remove()">Close</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

async function approveApplication(id, type) {
  if (!confirm('Are you sure you want to approve this application?')) return;
  
  try {
    const response = await fetch(`/api/admin/${type}/${id}/approve`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.success) {
      alert('Application approved successfully!');
      if (gazettedTable) gazettedTable.ajax.reload();
      if (nonGazettedTable) nonGazettedTable.ajax.reload();
      if (approvedTable) approvedTable.ajax.reload();
      if (rejectedTable) rejectedTable.ajax.reload();
      if (dashboardTable) dashboardTable.ajax.reload();
      loadCounts();
      showSection('approved-apps');
    } else {
      throw new Error(result.error || 'Failed to approve');
    }
  } catch (error) {
    console.error('Error approving application:', error);
    alert('Error: ' + error.message);
  }
}

function showRejectDialog(id, type) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h5>Reject Application</h5>
        <button class="modal-close" onclick="this.closest('.modal').remove()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Reason for rejection:</label>
          <textarea id="reject-reason" class="form-control" rows="3" required></textarea>
        </div>
        <div class="text-end">
          <button class="btn btn-secondary me-2" onclick="this.closest('.modal').remove()">Cancel</button>
          <button class="btn btn-danger" onclick="rejectApplication('${id}', '${type}', document.getElementById('reject-reason').value); this.closest('.modal').remove()">
            Confirm Reject
          </button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

async function rejectApplication(id, type, reason) {
  if (!reason.trim()) {
    alert('Please provide a reason for rejection');
    return;
  }
  
  try {
    const response = await fetch(`/api/admin/${type}/${id}/reject`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
      },
      body: JSON.stringify({ reason })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.success) {
      alert('Application rejected successfully!');
      if (gazettedTable) gazettedTable.ajax.reload();
      if (nonGazettedTable) nonGazettedTable.ajax.reload();
      if (approvedTable) approvedTable.ajax.reload();
      if (rejectedTable) rejectedTable.ajax.reload();
      if (dashboardTable) dashboardTable.ajax.reload();
      loadCounts();
      showSection('rejected-apps');
    } else {
      throw new Error(result.error || 'Failed to reject');
    }
  } catch (error) {
    console.error('Error rejecting application:', error);
    alert('Error: ' + error.message);
  }
}

// Admin login form submission
document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
 
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  const messageDiv = document.getElementById('login-message');
 
  messageDiv.innerHTML = '<div class="loading-spinner"></div> Logging in...';
 
  try {
    const response = await fetch('/api/admin/login', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ username, password })
    });
   
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
   
    const result = await response.json();
   
    if (result.success) {
      localStorage.setItem('adminToken', result.token);
      showAdminPanel();
      initializeDataTables();
      initializeDateRangePicker();
      messageDiv.innerHTML = '<div class="alert alert-success">Login successful!</div>';
      setTimeout(() => messageDiv.innerHTML = '', 3000);
    } else {
      throw new Error(result.error || 'Invalid credentials');
    }
  } catch (error) {
    console.error('Login error:', error);
    messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
  }
});

function showAdminPanel() {
  document.getElementById('login-section').style.display = 'none';
  document.getElementById('admin-panel').style.display = 'flex';
}

function logout() {
  if (confirm('Are you sure you want to logout?')) {
    localStorage.removeItem('adminToken');
    window.location.reload();
  }
}

function showSection(sectionId) {
  document.querySelectorAll('.content-section').forEach(section => {
    section.style.display = 'none';
  });
  document.getElementById(sectionId).style.display = 'block';
  
  document.querySelectorAll('.sidebar a').forEach(link => {
    link.classList.remove('active');
  });
  document.querySelector(`.sidebar a[onclick*="${sectionId}"]`).classList.add('active');
  
  if (sectionId === 'home' && dashboardTable) {
    dashboardTable.ajax.reload();
  } else if (sectionId === 'gazetted-table' && gazettedTable) {
    gazettedTable.ajax.reload();
  } else if (sectionId === 'non-gazetted-table' && nonGazettedTable) {
    nonGazettedTable.ajax.reload();
  } else if (sectionId === 'approved-apps' && approvedTable) {
    approvedTable.ajax.reload();
  } else if (sectionId === 'rejected-apps' && rejectedTable) {
    rejectedTable.ajax.reload();
  }
}

// Handle password change form
document.getElementById('change-password-form').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const currentPassword = document.getElementById('current-password').value;
  const newPassword = document.getElementById('new-password').value;
  const confirmPassword = document.getElementById('confirm-password').value;
  const messageDiv = document.getElementById('password-change-message');
  
  if (newPassword !== confirmPassword) {
    messageDiv.innerHTML = '<div class="alert alert-danger">New passwords do not match</div>';
    return;
  }
  
  try {
    messageDiv.innerHTML = '<div class="loading-spinner"></div> Updating password...';
    
    const response = await fetch('/api/admin/change-password', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
      },
      body: JSON.stringify({
        currentPassword,
        newPassword
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const result = await response.json();
    
    if (result.success) {
      messageDiv.innerHTML = '<div class="alert alert-success">Password changed successfully!</div>';
      document.getElementById('change-password-form').reset();
    } else {
      throw new Error(result.error || 'Error changing password');
    }
  } catch (error) {
    console.error('Error changing password:', error);
    messageDiv.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
  }
});

// Handle keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay').forEach(modal => modal.remove());
  }
});
</script>
</body>
</html>